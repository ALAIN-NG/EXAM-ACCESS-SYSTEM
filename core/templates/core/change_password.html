<!-- core/templates/core/change_password.html -->
{% extends "base_dashboard.html" %}

{% block title %}Changer le mot de passe{% endblock %}
{% block page_title %}Changer mon mot de passe{% endblock %}

{% block dashboard_title %}Sécurité du compte{% endblock %}
{% block dashboard_subtitle %}Modifiez votre mot de passe{% endblock %}

{% block dashboard_content %}
<div class="row justify-content-center">
    <div class="col-lg-6">
        <div class="card">
            <div class="card-body">
                <h4 class="card-title mb-4">
                    <i class="fas fa-key"></i> Changer le mot de passe
                </h4>
                
                {% if messages %}
                <div class="messages">
                    {% for message in messages %}
                    <div class="alert alert-{{ message.tags }} alert-dismissible fade show">
                        {{ message }}
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    </div>
                    {% endfor %}
                </div>
                {% endif %}
                
                <form method="post" id="password-change-form">
                    {% csrf_token %}
                    
                    {% if form.errors %}
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-triangle"></i>
                        Veuillez corriger les erreurs ci-dessous.
                    </div>
                    {% endif %}
                    
                    <!-- Ancien mot de passe -->
                    <div class="mb-4">
                        <label for="{{ form.old_password.id_for_label }}" class="form-label">
                            <i class="fas fa-lock"></i> {{ form.old_password.label }}
                        </label>
                        <div class="input-group">
                            <input type="password" 
                                   name="{{ form.old_password.name }}"
                                   id="{{ form.old_password.id_for_label }}"
                                   class="form-control {% if form.old_password.errors %}is-invalid{% endif %}"
                                   placeholder="Entrez votre mot de passe actuel">
                            <button class="btn btn-outline-secondary" type="button" id="toggle-old-password">
                                <i class="fas fa-eye"></i>
                            </button>
                            {% if form.old_password.errors %}
                            <div class="invalid-feedback">
                                {{ form.old_password.errors.0 }}
                            </div>
                            {% endif %}
                        </div>
                        <small class="text-muted">Le mot de passe actuel de votre compte.</small>
                    </div>
                    
                    <!-- Nouveau mot de passe -->
                    <div class="mb-4">
                        <label for="{{ form.new_password1.id_for_label }}" class="form-label">
                            <i class="fas fa-key"></i> {{ form.new_password1.label }}
                        </label>
                        <div class="input-group">
                            <input type="password" 
                                   name="{{ form.new_password1.name }}"
                                   id="{{ form.new_password1.id_for_label }}"
                                   class="form-control {% if form.new_password1.errors %}is-invalid{% endif %}"
                                   placeholder="Entrez votre nouveau mot de passe">
                            <button class="btn btn-outline-secondary" type="button" id="toggle-new-password">
                                <i class="fas fa-eye"></i>
                            </button>
                            {% if form.new_password1.errors %}
                            <div class="invalid-feedback">
                                {{ form.new_password1.errors.0 }}
                            </div>
                            {% endif %}
                        </div>
                        <div class="mt-2">
                            <div class="password-strength">
                                <div class="progress" style="height: 5px;">
                                    <div class="progress-bar" id="password-strength-bar" style="width: 0%"></div>
                                </div>
                                <small class="text-muted" id="password-strength-text">Force du mot de passe</small>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Confirmation du nouveau mot de passe -->
                    <div class="mb-4">
                        <label for="{{ form.new_password2.id_for_label }}" class="form-label">
                            <i class="fas fa-key"></i> {{ form.new_password2.label }}
                        </label>
                        <div class="input-group">
                            <input type="password" 
                                   name="{{ form.new_password2.name }}"
                                   id="{{ form.new_password2.id_for_label }}"
                                   class="form-control {% if form.new_password2.errors %}is-invalid{% endif %}"
                                   placeholder="Confirmez votre nouveau mot de passe">
                            <button class="btn btn-outline-secondary" type="button" id="toggle-confirm-password">
                                <i class="fas fa-eye"></i>
                            </button>
                            {% if form.new_password2.errors %}
                            <div class="invalid-feedback">
                                {{ form.new_password2.errors.0 }}
                            </div>
                            {% endif %}
                        </div>
                        <div class="mt-2">
                            <div class="form-check">
                                <input type="checkbox" class="form-check-input" id="show-requirements">
                                <label class="form-check-label small" for="show-requirements">
                                    Afficher les exigences de sécurité
                                </label>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Exigences de sécurité -->
                    <div class="card bg-light mb-4" id="password-requirements" style="display: none;">
                        <div class="card-body">
                            <h6 class="card-title">
                                <i class="fas fa-shield-alt"></i> Exigences de sécurité
                            </h6>
                            <ul class="list-unstyled small mb-0">
                                <li id="req-length" class="text-muted">
                                    <i class="fas fa-circle"></i> Au moins 8 caractères
                                </li>
                                <li id="req-letter" class="text-muted">
                                    <i class="fas fa-circle"></i> Au moins une lettre
                                </li>
                                <li id="req-digit" class="text-muted">
                                    <i class="fas fa-circle"></i> Au moins un chiffre
                                </li>
                                <li id="req-special" class="text-muted">
                                    <i class="fas fa-circle"></i> Au moins un caractère spécial
                                </li>
                                <li id="req-different" class="text-muted">
                                    <i class="fas fa-circle"></i> Différent de l'ancien mot de passe
                                </li>
                            </ul>
                        </div>
                    </div>
                    
                    <!-- Boutons -->
                    <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                        <a href="{% url 'profile' %}" class="btn btn-outline-secondary me-md-2">
                            <i class="fas fa-times"></i> Annuler
                        </a>
                        <button type="submit" class="btn btn-primary" id="submit-button">
                            <i class="fas fa-save"></i> Changer le mot de passe
                        </button>
                    </div>
                </form>
            </div>
        </div>
        
        <!-- Conseils de sécurité -->
        <div class="card mt-4">
            <div class="card-body">
                <h5 class="card-title mb-3">
                    <i class="fas fa-lightbulb"></i> Conseils de sécurité
                </h5>
                <ul class="list-unstyled small">
                    <li class="mb-2">
                        <i class="fas fa-check text-success"></i>
                        <strong>Utilisez un mot de passe unique</strong> que vous n'utilisez pas ailleurs
                    </li>
                    <li class="mb-2">
                        <i class="fas fa-check text-success"></i>
                        <strong>Évitez les informations personnelles</strong> comme votre date de naissance
                    </li>
                    <li class="mb-2">
                        <i class="fas fa-check text-success"></i>
                        <strong>Changez régulièrement</strong> votre mot de passe (tous les 3 mois)
                    </li>
                    <li class="mb-2">
                        <i class="fas fa-check text-success"></i>
                        <strong>Ne partagez jamais</strong> votre mot de passe avec qui que ce soit
                    </li>
                    <li>
                        <i class="fas fa-check text-success"></i>
                        <strong>Utilisez un gestionnaire de mots de passe</strong> si nécessaire
                    </li>
                </ul>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
    .password-strength .progress-bar {
        transition: width 0.3s ease;
    }
    
    .strength-weak {
        background-color: #e74c3c;
    }
    
    .strength-fair {
        background-color: #f39c12;
    }
    
    .strength-good {
        background-color: #3498db;
    }
    
    .strength-strong {
        background-color: #27ae60;
    }
    
    .requirement-met {
        color: #27ae60;
    }
    
    .requirement-not-met {
        color: #e74c3c;
    }
    
    .password-input-group {
        position: relative;
    }
    
    .password-toggle {
        position: absolute;
        right: 10px;
        top: 50%;
        transform: translateY(-50%);
        background: none;
        border: none;
        color: #666;
        cursor: pointer;
    }
    
    .security-tips {
        background-color: #f8f9fa;
        border-radius: 10px;
        padding: 20px;
        margin-top: 30px;
    }
</style>
{% endblock %}

{% block extra_js %}
<script>
    $(document).ready(function() {
        // Basculer l'affichage des mots de passe
        $('#toggle-old-password').click(function() {
            togglePasswordVisibility('#{{ form.old_password.id_for_label }}', $(this));
        });
        
        $('#toggle-new-password').click(function() {
            togglePasswordVisibility('#{{ form.new_password1.id_for_label }}', $(this));
        });
        
        $('#toggle-confirm-password').click(function() {
            togglePasswordVisibility('#{{ form.new_password2.id_for_label }}', $(this));
        });
        
        // Afficher/masquer les exigences
        $('#show-requirements').change(function() {
            if ($(this).is(':checked')) {
                $('#password-requirements').slideDown();
            } else {
                $('#password-requirements').slideUp();
            }
        });
        
        // Vérifier la force du mot de passe
        $('#{{ form.new_password1.id_for_label }}').on('input', function() {
            checkPasswordStrength($(this).val());
        });
        
        // Vérifier la correspondance des mots de passe
        $('#{{ form.new_password2.id_for_label }}').on('input', function() {
            checkPasswordMatch();
        });
        
        // Validation du formulaire
        $('#password-change-form').submit(function(e) {
            if (!validatePasswordForm()) {
                e.preventDefault();
            }
        });
        
        // Initialiser les vérifications
        checkPasswordStrength($('#{{ form.new_password1.id_for_label }}').val());
        checkPasswordMatch();
    });
    
    function togglePasswordVisibility(inputSelector, button) {
        const input = $(inputSelector);
        const type = input.attr('type') === 'password' ? 'text' : 'password';
        input.attr('type', type);
        
        // Changer l'icône
        const icon = button.find('i');
        if (type === 'text') {
            icon.removeClass('fa-eye').addClass('fa-eye-slash');
        } else {
            icon.removeClass('fa-eye-slash').addClass('fa-eye');
        }
    }
    
    function checkPasswordStrength(password) {
        let strength = 0;
        const requirements = {
            length: false,
            letter: false,
            digit: false,
            special: false,
            different: false
        };
        
        // Longueur
        if (password.length >= 8) {
            strength += 25;
            requirements.length = true;
            $('#req-length').addClass('requirement-met').removeClass('requirement-not-met text-muted')
                .find('i').removeClass('fa-circle').addClass('fa-check-circle');
        } else {
            $('#req-length').addClass('requirement-not-met').removeClass('requirement-met text-muted')
                .find('i').removeClass('fa-check-circle').addClass('fa-circle');
        }
        
        // Lettre
        if (/[a-zA-Z]/.test(password)) {
            strength += 25;
            requirements.letter = true;
            $('#req-letter').addClass('requirement-met').removeClass('requirement-not-met text-muted')
                .find('i').removeClass('fa-circle').addClass('fa-check-circle');
        } else {
            $('#req-letter').addClass('requirement-not-met').removeClass('requirement-met text-muted')
                .find('i').removeClass('fa-check-circle').addClass('fa-circle');
        }
        
        // Chiffre
        if (/[0-9]/.test(password)) {
            strength += 25;
            requirements.digit = true;
            $('#req-digit').addClass('requirement-met').removeClass('requirement-not-met text-muted')
                .find('i').removeClass('fa-circle').addClass('fa-check-circle');
        } else {
            $('#req-digit').addClass('requirement-not-met').removeClass('requirement-met text-muted')
                .find('i').removeClass('fa-check-circle').addClass('fa-circle');
        }
        
        // Caractère spécial
        if (/[^a-zA-Z0-9]/.test(password)) {
            strength += 25;
            requirements.special = true;
            $('#req-special').addClass('requirement-met').removeClass('requirement-not-met text-muted')
                .find('i').removeClass('fa-circle').addClass('fa-check-circle');
        } else {
            $('#req-special').addClass('requirement-not-met').removeClass('requirement-met text-muted')
                .find('i').removeClass('fa-check-circle').addClass('fa-circle');
        }
        
        // Différent de l'ancien
        const oldPassword = $('#{{ form.old_password.id_for_label }}').val();
        if (password !== oldPassword) {
            requirements.different = true;
            $('#req-different').addClass('requirement-met').removeClass('requirement-not-met text-muted')
                .find('i').removeClass('fa-circle').addClass('fa-check-circle');
        } else {
            $('#req-different').addClass('requirement-not-met').removeClass('requirement-met text-muted')
                .find('i').removeClass('fa-check-circle').addClass('fa-circle');
        }
        
        // Mettre à jour la barre de progression
        const bar = $('#password-strength-bar');
        bar.css('width', strength + '%');
        
        // Mettre à jour le texte et la couleur
        const text = $('#password-strength-text');
        if (strength < 50) {
            bar.removeClass('strength-fair strength-good strength-strong').addClass('strength-weak');
            text.text('Faible').css('color', '#e74c3c');
        } else if (strength < 75) {
            bar.removeClass('strength-weak strength-good strength-strong').addClass('strength-fair');
            text.text('Moyen').css('color', '#f39c12');
        } else if (strength < 100) {
            bar.removeClass('strength-weak strength-fair strength-strong').addClass('strength-good');
            text.text('Bon').css('color', '#3498db');
        } else {
            bar.removeClass('strength-weak strength-fair strength-good').addClass('strength-strong');
            text.text('Fort').css('color', '#27ae60');
        }
        
        return requirements;
    }
    
    function checkPasswordMatch() {
        const password1 = $('#{{ form.new_password1.id_for_label }}').val();
        const password2 = $('#{{ form.new_password2.id_for_label }}').val();
        const input2 = $('#{{ form.new_password2.id_for_label }}');
        
        if (password1 && password2) {
            if (password1 === password2) {
                input2.removeClass('is-invalid').addClass('is-valid');
            } else {
                input2.removeClass('is-valid').addClass('is-invalid');
            }
        } else {
            input2.removeClass('is-valid is-invalid');
        }
    }
    
    function validatePasswordForm() {
        let isValid = true;
        
        // Vérifier l'ancien mot de passe
        const oldPassword = $('#{{ form.old_password.id_for_label }}').val();
        if (!oldPassword) {
            $('#{{ form.old_password.id_for_label }}').addClass('is-invalid');
            isValid = false;
        }
        
        // Vérifier le nouveau mot de passe
        const newPassword = $('#{{ form.new_password1.id_for_label }}').val();
        const requirements = checkPasswordStrength(newPassword);
        
        if (!requirements.length || !requirements.letter || !requirements.digit || !requirements.special) {
            showAlert('error', 'Le mot de passe ne respecte pas toutes les exigences de sécurité.');
            isValid = false;
        }
        
        // Vérifier la correspondance
        const confirmPassword = $('#{{ form.new_password2.id_for_label }}').val();
        if (newPassword !== confirmPassword) {
            showAlert('error', 'Les mots de passe ne correspondent pas.');
            isValid = false;
        }
        
        // Vérifier si différent de l'ancien
        if (newPassword === oldPassword) {
            showAlert('error', 'Le nouveau mot de passe doit être différent de l\'ancien.');
            isValid = false;
        }
        
        return isValid;
    }
    
    function showAlert(type, message) {
        // Supprimer les anciennes alertes
        $('.alert-dismissible:not(.messages .alert)').remove();
        
        const alertClass = type === 'error' ? 'danger' : 'success';
        const icon = type === 'error' ? 'exclamation-triangle' : 'check-circle';
        
        const alert = `
            <div class="alert alert-${alertClass} alert-dismissible fade show mt-3">
                <i class="fas fa-${icon}"></i>
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
        `;
        
        $('#password-change-form').prepend(alert);
        
        // Faire défiler jusqu'à l'alerte
        $('html, body').animate({
            scrollTop: $('.alert').offset().top - 100
        }, 500);
    }
</script>
{% endblock %}