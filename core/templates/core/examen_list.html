{% extends "base_dashboard.html" %}

{% block title %}Liste des examens{% endblock %}
{% block page_title %}Gestion des examens{% endblock %}

{% block dashboard_content %}
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-body">
                <h4 class="card-title mb-4">
                    <i class="fas fa-filter"></i> Filtres
                </h4>
                
                <form method="get" class="row g-3">
                    <div class="col-md-3">
                        <label for="date" class="form-label">Date</label>
                        <input type="date" 
                               class="form-control" 
                               id="date" 
                               name="date" 
                               value="{{ date_filter|default:'' }}">
                    </div>
                    <div class="col-md-3">
                        <label for="type" class="form-label">Type</label>
                        <select class="form-select" id="type" name="type">
                            <option value="">Tous les types</option>
                            <option value="normal">Session normale</option>
                            <option value="rattrapage">Session de rattrapage</option>
                        </select>
                    </div>
                    <div class="col-md-3 d-flex align-items-end">
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-search"></i> Filtrer
                        </button>
                        {% if date_filter %}
                        <a href="{% url 'examen_list' %}" class="btn btn-outline-secondary ms-2">
                            <i class="fas fa-times"></i> Effacer
                        </a>
                        {% endif %}
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-body">
                <h4 class="card-title mb-4">
                    <i class="fas fa-calendar-alt"></i> Liste des examens
                    <span class="badge bg-primary float-end">{{ examens|length }}</span>
                </h4>
                
                {% if examens %}
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>UE</th>
                                <th>Salle</th>
                                <th>Horaire</th>
                                <th>Surveillant</th>
                                <th>Type</th>
                                <th>Statut</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for examen in examens %}
                            <tr class="{% if examen.date < today %}table-secondary{% elif examen.date == today %}table-info{% endif %}">
                                <td>
                                    {{ examen.date|date:"d/m/Y" }}<br>
                                    <small class="text-muted">{{ examen.date|date:"l" }}</small>
                                </td>
                                <td>
                                    <strong>{{ examen.ue.code }}</strong><br>
                                    <small class="text-muted">{{ examen.ue.intitule|truncatechars:30 }}</small>
                                </td>
                                <td>
                                    <span class="badge bg-secondary">{{ examen.salle.code|default:"N/A" }}</span><br>
                                    <small>{{ examen.salle.capacite|default:"?" }} places</small>
                                </td>
                                <td>
                                    {{ examen.heure_debut|time:"H:i" }} - {{ examen.heure_fin|time:"H:i" }}<br>
                                    <small class="text-muted">{{ examen.duree }} min</small>
                                </td>
                                <td>
                                    {% if examen.surveillant %}
                                    {{ examen.surveillant.get_full_name|default:examen.surveillant.username }}
                                    {% else %}
                                    <span class="text-warning">À assigner</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <span class="badge {% if examen.type_examen == 'normal' %}bg-success{% else %}bg-warning{% endif %}">
                                        {{ examen.get_type_examen_display }}
                                    </span>
                                </td>
                                <td>
                                    {% if examen.date < today %}
                                    <span class="badge bg-secondary">Passé</span>
                                    {% elif examen.date == today %}
                                        {% if examen.est_en_cours %}
                                        <span class="badge bg-success">En cours</span>
                                        {% elif examen.est_termine %}
                                        <span class="badge bg-secondary">Terminer</span>
                                        {% else %}
                                        <span class="badge bg-warning">Aujourd'hui</span>
                                        {% endif %}
                                    {% else %}
                                    <span class="badge bg-info">À venir</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <div class="btn-group btn-group-sm">
                                        <a href="{% url 'examen_detail' examen.id %}" 
                                           class="btn btn-outline-primary" 
                                           title="Détails">
                                            <i class="fas fa-eye"></i>
                                        </a>
                                        
                                        {% if user.groups.all.0.name == 'Surveillant' or user.is_staff %}
                                        <a href="{% url 'scan_examen' examen.id %}" 
                                           class="btn btn-outline-success" 
                                           title="Scanner">
                                            <i class="fas fa-qrcode"></i>
                                        </a>
                                        {% endif %}
                                        
                                        {% if user.is_staff or user.groups.all.0.name == 'Administrateur' %}
                                        <a href="{% url 'admin:core_examen_change' examen.id %}" 
                                           class="btn btn-outline-warning" 
                                           title="Modifier">
                                            <i class="fas fa-edit"></i>
                                        </a>
                                        {% endif %}
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="text-center py-5">
                    <i class="fas fa-calendar-times text-muted" style="font-size: 3rem;"></i>
                    <h5 class="mt-3">Aucun examen trouvé</h5>
                    <p class="text-muted">
                        {% if date_filter %}
                        Aucun examen programmé pour cette date.
                        {% else %}
                        Aucun examen disponible selon vos permissions.
                        {% endif %}
                    </p>
                    <a href="{% url 'examen_list' %}" class="btn btn-primary">
                        <i class="fas fa-redo"></i> Voir tous les examens
                    </a>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endblock %}